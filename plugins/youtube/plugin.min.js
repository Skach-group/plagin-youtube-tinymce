
tinymce.PluginManager.add('youtube', function(editor, url) {	
  var openDialog = function (alt_img, id_video) {	  
    return editor.windowManager.open({		
      title: 'Вставка видео из YouTube',
      body: {
        type: 'panel',
        items: [
          {
            type: 'input',
            name: 'alt_img',
            label: 'Наименование видео'
          },		
          {
            type: 'input',
            name: 'id_video',
            label: 'ID видео (только номер ID, например CTb9ZqUM2Hw)'
          }		  
        ]
      },
      buttons: [
        {
          type: 'cancel',
          text: 'Close'
        },
        {
          type: 'submit',
          text: 'Save',
          primary: true
        }
      ],
	  initialData: { 
		alt_img: alt_img,
		id_video: id_video
	  },	  
      onSubmit: function (api) { 		
        var data = api.getData();
		// Борьба с Администратором сайта
		if(data.alt_img){
			data.alt_img = data.alt_img.replace(/[^A-Za-zА-Яа-я0-9І-іЇ-ї-\s!?]/g, '').trim();
		}else{
			data.alt_img = 'Video YouTube';
		}	
		if(data.id_video){
			editor.insertContent('<img class="img-fluid" src="https://img.youtube.com/vi/'+data.id_video+'/hqdefault.jpg" alt="'+data.alt_img+'"  id-video="'+data.id_video+'" style="display: block; margin-left: auto; margin-right: auto;">');		
		}else{
			editor.insertContent('<p style="color:red;">Ошибка! Не указан ID видео!</p>');
		}
		api.close();
      }
    });
  };

  // Текст для кнопки в редакторе
  editor.ui.registry.addButton('youtube', {
    text: 'YouTube',
	tooltip: 'Вставка видео из YouTube',
    onAction: function () {
	  var alt_img = tinymce.activeEditor.selection.getNode().getAttribute('alt');
	  if(alt_img === null){
		  alt_img = '';
	  }
	  var id_video = tinymce.activeEditor.selection.getNode().getAttribute('id-video');
	  if(id_video === null){
		  id_video = '';
	  }	
      // Open window
      openDialog(alt_img, id_video);
    }	
  });

  // Adds a menu item, which can then be included in any menu via the menu/menubar configuration
  editor.ui.registry.addMenuItem('youtube', {
    text: 'Video YouTube',
    onAction: function () {
	  var alt_img = tinymce.activeEditor.selection.getNode().getAttribute('alt');
	  if(alt_img === null){
		  alt_img = '';
	  }
	  var id_video = tinymce.activeEditor.selection.getNode().getAttribute('id-video');
	  if(id_video === null){
		  id_video = '';
	  }	
      // Open window
      openDialog(alt_img, id_video);
    }
  });

  return {
    getMetadata: function () {
      return  {
        name: "YouTube plugin",
        url: "https://skachgroup.ru"
      };
    }
  };
});
